name: Deploy Backend to Server

on:
  push:
    branches:
      - main
    paths:
      - 'food-tracker-server/**'
      - '.github/workflows/deploy-backend.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3

      - name: Build and Package
        run: |
          cd food-tracker-server
          npm install
          npm run build
          
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd /home/${{ secrets.SERVER_USER }}/food-tracker-V2/food-tracker-server
            git pull origin main
            npm install
            npm run build
            pm2 restart food-tracker-backend || pm2 start dist/index.js --name "food-tracker-backend"
            pm2 save

      - name: Notify Deployment
        if: success()
        run: echo "✅ Backend deployed successfully to ${{ secrets.SERVER_HOST }}"

      - name: Notify Failure
        if: failure()
        run: echo "❌ Backend deployment failed"
